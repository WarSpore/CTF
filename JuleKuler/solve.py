import numpy as np
from sympy.ntheory.modular import crt
from Crypto.Util.number import long_to_bytes

HJORNERR = np.array([
    (-2, -2),
    (2, -2),
    (2, 2),
    (10, 2),
    (4, 10),
    (8, 10),
    (2, 18),
    (6, 18),
    (0, 26),
    (-6, 18),
    (-2, 18),
    (-8, 10),
    (-4, 10),
    (-10, 2),
    (-2, 2)
], dtype=float)

KUMMULATIV = np.array([0, 4, 8, 16, 26, 30, 40, 44, 54, 64, 68, 78, 82, 92, 100, 104], dtype=float)
OMKRETS = 104.0
ANDEL = KUMMULATIV / OMKRETS

JULEKULER = np.array([
    (6/5, 122/5), (-14/5, 254/15), (18/5, 18), (-114/35, 758/35),
    (222/55, 1134/55), (-2, -2), (106/17, 2), (110/19, 18),
    (606/115, 2182/115), (-158/29, 18), (70/31, 18), (-198/37, 18),
    (-1094/205, 2778/205), (1094/215, 1838/215), (-2, 10/47),
    (-174/53, 18), (-1954/295, 1918/295), (-1582/305, 4194/305),
    (2822/335, 1374/335), (-42/355, 9174/355), (1538/365, 3546/365),
    (-186/79, 1806/79), (1902/415, 8254/415), (-1806/445, 9162/445),
    (3578/485, 2666/485), (426/101, 18), (838/103, 2),
    (-5146/535, 1342/535), (-3758/545, 3346/545), (1090/113, 2),
    (-2202/635, 13574/635), (2, 46/131), (-334/137, 18),
    (-1034/139, 1494/139), (-1158/149, 2), (3406/755, 11062/755),
    (906/157, 2874/157), (-1338/163, 2), (-1018/167, 2),
    (5642/865, 10354/865), (-1042/179, 2310/179), (402/181, 18),
    (2678/955, 16166/955), (2, -118/193), (7138/985, 5586/985),
    (-2, -190/199), (8198/1055, 5246/1055), (5006/1115, 10422/1115),
    (-1002/227, 2), (-5646/1145, 22242/1145), (3738/1165, 25306/1165),
    (1374/239, 2), (-758/241, 3970/241), (-2258/251, 838/251),
    (-8374/1285, 8538/1285), (-11386/1315, 4982/1315),
    (7074/1345, 25538/1345), (8022/1355, 24534/1355),
    (-1982/277, 10), (2, 82/281), (1262/283, 10)
], dtype=float)

primes = [2,3,5,7,11,13,17,19,23,29,
          31,37,41,43,47,53,59,61,67,71,
          73,79,83,89,97,101,103,107,109,113,
          127,131,137,139,149,151,157,163,167,173,
          179,181,191,193,197,199,211,223,227,229,
          233,239,241,251,257,263,269,271,277,281,
          283,293,307,311,313,317,331,337,347,349,
          353,359]

n_edges = len(HJORNERR)
edges = HJORNERR[(np.arange(n_edges) + 1) % n_edges] - HJORNERR
edge_denoms = np.einsum('ij,ij->i', edges, edges)  # |AB|^2 for each edge

primes_calc = []
res = []

for c, P in enumerate(JULEKULER):
    AP = P - HJORNERR              # shape (15, 2)
    num = np.einsum('ij,ij->i', AP, edges)   # (P-A)Â·(B-A) for all edges
    u = num / edge_denoms
    u_clamped = np.clip(u, 0.0, 1.0)

    Q = HJORNERR + u_clamped[:, None] * edges   # proj for all edges
    d2 = np.einsum('ij,ij->i', Q - P, Q - P)
    best_i = np.argmin(d2)
    u_true = u_clamped[best_i]

    a0 = ANDEL[best_i]
    a1 = ANDEL[best_i + 1]
    t = a0 + u_true * (a1 - a0)

    p = primes[c]
    r = round(t * p)

    primes_calc.append(p)
    res.append(r)

N_val, _ = crt(primes_calc, res)
print(long_to_bytes(N_val).decode("latin-1"))
